# API Chat

## Описание сервиса

Этот FastAPI-сервис реализует функционал чата: создание чатов, добавление сообщений, получение и удаление чатов и сообщений.  

---

## Используемые библиотеки

| Библиотека               | Назначение                                      |
|--------------------------|-------------------------------------------------|
| `fastapi`               | REST API фреймворк                              |
| `uvicorn`               | ASGI-сервер                                     |
| `pydantic`              | Валидация и сериализация данных                |
| `alembic`               | Библиотека для работы с миграциями БД         |
| `sqlalchemy`            | ORM для работы с базой данных                  |
| `psycopg2`              | PostgreSQL драйвер для SQLAlchemy              |
| `pytest`                | Фреймворк для тестов    |
| `poetry`                | Менеджер зависимостей и виртуального окружения |

---

## Структура проекта

```
├── src/
  ├── app/
    ├── api/
      └── routes.py           # Роуты API
    ├── db/
      ├── crud.py             # Операции CRUD, используемые при работе с бд
      ├── models.py           # SQLAlchemy модели
      └── session.py          # Подключение к БД и сессия
    ├── migrations/           # Миграции БД
    ├── logic.py              # Бизнес-логика для обработки данных
    ├── schemas.py            # Pydantic-модели для запросов и ответов
    └── service.py            # Точка входа в FastAPI-приложение
  ├── tests/
    └── test_integration.py   # Интеграционные тесты
├── Dockerfile                # Создание образа сервиса
├── docker-compose.yml        # Запуск сервиса и БД через контейнеры
├── pyproject.toml            # Зависимости проекта (Poetry)
└── README.md                 # Этот файл
```

---

## Описание файлов

### `src/app/api/routes.py`
Инициализация маршрутов и обработчиков:
- Создание чата
- Создание сообщений
- Получение чата и сообщений
- Удаление чата

### `src/app/logic.py`
Функции для создания объектов `Chat` и `Message` из данных запросов (бизнес-логика).

### `src/app/db/crud.py`
Функции для работы с базой данных:
- Сохранение чата и сообщений
- Получение чата и сообщений
- Удаление чата

### `src/app/db/models.py`
Описание структуры базы данных с помощью SQLAlchemy.

### `src/app/db/session.py`
Подключение к PostgreSQL, создание `SessionLocal` и базового класса `Base`.

### `src/app/schemas.py`
Pydantic-модели для валидации и сериализации запросов и ответов:
- `ChatCreate`, `ChatSchema`
- `MessageCreate`, `MessageSchema`

### `src/app/migrations/`
Миграции базы данных (Alembic).

### `src/tests/`
Интеграционные тесты:
- Проверка создания/удаления чатов
- Проверка создания сообщений
- Проверка получения чатов

### `Dockerfile`
Создание образа сервиса и установкой зависимостей через Poetry.

### `docker-compose.yml`
Запуск сервиса и PostgreSQL через Docker Compose.

### `pyproject.toml`
Список зависимостей проекта, управляется через Poetry.

---

## Запуск проекта
### Сборка и запуск через Docker Compose:
```bash
docker-compose up --build
```

### Доступ к Swagger:
```bash
http://localhost:8000/docs
```

### Применение миграций внутри контейнера:
```bash
docker compose exec api alembic upgrade head
```

### Запуск тестов внутри контейнера
```bash
docker compose run api pytest
```

### Удаление контейнеров

```bash
docker-compose down -v
```
